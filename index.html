<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DormMate - Live Online</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; user-select: none; -webkit-user-select: none; overflow: hidden; touch-action: none; }
        @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 10% { opacity: 0.8; } 100% { transform: translateY(-100vh) rotate(20deg); opacity: 0; } }
        @keyframes sway { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        .animate-float { animation: floatUp 15s linear infinite; }
        .animate-sway { animation: sway 3s ease-in-out infinite; transform-origin: top center; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .neon-text { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #818cf8; border: 2px solid rgba(255,255,255,0.8); cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
    </style>
</head>
<body class="bg-gradient-to-b from-indigo-950 via-slate-900 to-indigo-950 text-white h-screen w-screen relative">

    <div id="bg-effects" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>
    <div id="app" class="relative z-10 h-full w-full max-w-md mx-auto p-4 flex flex-col">
        <div class="flex-1 flex items-center justify-center">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-400"></i>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, query, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        let firebaseConfig;
        let appId = 'default-app-id';
        
        // 1. If running in the online preview, use the environment config:
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } else {
            // 2. IF RUNNING LOCALLY (Downloaded file):
            // PASTE YOUR FIREBASE CONFIGURATION HERE:
            firebaseConfig = {
                apiKey: "AIzaSyCFt_vIqaKbhvmAfd_YAnpsTI2kZq1LZg8",
                authDomain: "dormmate-c1e77.firebaseapp.com",
                projectId: "dormmate-c1e77",
                storageBucket: "dormmate-c1e77.firebasestorage.app",
                messagingSenderId: "1018553026390",
                appId: "1:1018553026390:web:6a02352417d6dd16d878f7",
                measurementId: "G-1Z6FEPDM36"
            };
            
            if (!firebaseConfig.apiKey) {
                console.warn("No Firebase Config Found.");
                // We show a UI message instead of alert to be less intrusive
                setTimeout(() => {
                    const app = document.getElementById('app');
                    if(app) app.innerHTML = `<div class="p-8 text-center"><h1 class="text-xl font-bold mb-4">Setup Required</h1><p>Open this file in a text editor and paste your Firebase Config keys where indicated.</p></div>`;
                }, 1000);
            }
        }

        // --- APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constants
        const SCHOOLS = ["State University", "Tech Institute", "City College", "Art Academy"];
        const GENDERS = ["Female", "Male", "Non-binary"];

        // State
        let state = {
            user: null,
            profile: null,
            view: 'loading',
            matches: [],
            chatPartner: null,
            messages: [],
            official: null,
            dragStart: null,
            dragOffset: 0,
            unsubscribeChat: null
        };

        // --- AUTH & INIT ---
        async function init() {
            initBackground();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user = user;
                    listenToProfile();
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }

        function listenToProfile() {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', state.user.uid);
            onSnapshot(userRef, (snap) => {
                if (snap.exists()) {
                    state.profile = snap.data();
                    
                    if (state.profile.officialRoommateId) {
                        state.official = { id: state.profile.officialRoommateId }; 
                    } else {
                        state.official = null;
                    }
                    
                    if(state.view === 'loading' || state.view === 'onboarding') {
                        state.view = 'dashboard';
                        listenToMatches();
                    }
                    render();
                } else {
                    state.view = 'onboarding';
                    render();
                }
            });
        }

        function listenToMatches() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            onSnapshot(q, (snapshot) => {
                const allUsers = [];
                let partnerProfile = null;

                snapshot.forEach(d => {
                    const u = { id: d.id, ...d.data() };
                    if (u.id === state.user.uid) return; 
                    
                    if (state.profile?.officialRoommateId === u.id) {
                        partnerProfile = u;
                    }
                    
                    // Safe access to profile properties
                    const mySchool = state.profile?.school;
                    const myGender = state.profile?.gender;
                    
                    if (u.school === mySchool && u.gender === myGender && !u.officialRoommateId) {
                        let score = 100;
                        const myClean = state.profile?.clean || 3;
                        const myNoise = state.profile?.noise || 3;
                        
                        score -= Math.abs((u.clean || 3) - myClean) * 10;
                        score -= Math.abs((u.noise || 3) - myNoise) * 10;
                        u.score = Math.max(0, score);
                        allUsers.push(u);
                    }
                });

                if (state.profile?.officialRoommateId && partnerProfile) {
                    state.official = partnerProfile;
                    state.matches = [];
                } else {
                    state.matches = allUsers.sort((a,b) => b.score - a.score);
                }
                render();
            });
        }

        // --- GLOBAL ACTIONS ---
        window.saveProfile = async () => {
            const name = document.getElementById('inp-name').value;
            const school = document.getElementById('inp-school').value;
            const gender = document.getElementById('inp-gender').value;
            const major = document.getElementById('inp-major').value;
            const bio = document.getElementById('inp-bio').value;
            const clean = parseInt(document.getElementById('inp-clean').value);
            const noise = parseInt(document.getElementById('inp-noise').value);

            if(!name || !major) return alert("Please fill in all fields");

            const userData = {
                name, school, gender, major, bio, clean, noise,
                officialRoommateId: null,
                updatedAt: new Date().toISOString()
            };

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', state.user.uid), userData);
        };

        window.handleSwipe = (dir) => {
            state.dragOffset = 0;
            const current = state.matches[0];
            if (dir === 'right') {
                window.openChat(current);
            } else {
                state.matches.shift();
                render();
            }
        };

        window.openChat = (partner) => {
            state.chatPartner = partner;
            state.view = 'chat';
            render();
            
            const chatId = [state.user.uid, partner.id].sort().join('_');
            const msgsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
            
            if (state.unsubscribeChat) state.unsubscribeChat();
            
            state.unsubscribeChat = onSnapshot(msgsRef, (snap) => {
                const msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                state.messages = msgs.sort((a,b) => a.timestamp - b.timestamp);
                render();
                setTimeout(() => {
                    const box = document.getElementById('chat-box');
                    if(box) box.scrollTop = box.scrollHeight;
                }, 100);
            });
        };

        window.sendMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            input.value = '';
            
            const chatId = [state.user.uid, state.chatPartner.id].sort().join('_');
            const msgsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
            
            await addDoc(msgsRef, {
                text,
                senderId: state.user.uid,
                timestamp: Date.now()
            });
        };

        window.requestMatch = async () => {
            const confirmed = confirm("Ask to be official roommates?");
            if(!confirmed) return;

            const chatId = [state.user.uid, state.chatPartner.id].sort().join('_');
            const msgsRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
            
            await addDoc(msgsRef, {
                text: "SYSTEM: Proposed to be Official Roommates! ðŸ’",
                isSystem: true,
                senderId: state.user.uid,
                type: 'proposal',
                timestamp: Date.now()
            });
        };

        window.acceptMatch = async () => {
            const myRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', state.user.uid);
            const theirRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', state.chatPartner.id);
            
            await updateDoc(myRef, { officialRoommateId: state.chatPartner.id });
            await updateDoc(theirRef, { officialRoommateId: state.user.uid });
            
            const chatId = [state.user.uid, state.chatPartner.id].sort().join('_');
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), {
                text: "SYSTEM: It's Official! ðŸŽ‰",
                isSystem: true,
                timestamp: Date.now()
            });
        };

        window.resetProfile = async () => {
            if(!confirm("Delete your profile and start over?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', state.user.uid));
        };

        window.goBack = () => {
            if (state.unsubscribeChat) state.unsubscribeChat();
            state.view = 'dashboard';
            render();
        };

        // --- RENDERER ---
        const appContainer = document.getElementById('app');

        function render() {
            appContainer.innerHTML = '';
            if (state.view === 'loading') {
                appContainer.innerHTML = `<div class="flex-1 flex items-center justify-center"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-400"></i></div>`;
            } else if (state.view === 'onboarding') {
                renderOnboarding();
            } else if (state.view === 'dashboard') {
                renderDashboard();
            } else if (state.view === 'chat') {
                renderChat();
            }
            if(window.lucide) lucide.createIcons();
        }

        function renderOnboarding() {
            appContainer.innerHTML = `
                <div class="flex-1 flex flex-col justify-center space-y-6 pt-8 animate-fade-in">
                    <div class="text-center">
                        <h1 class="text-4xl font-bold text-white neon-text mb-2">DormMate</h1>
                        <p class="text-indigo-200">Online Mode</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl space-y-4">
                        <input id="inp-name" type="text" placeholder="Name" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white">
                        <input id="inp-major" type="text" placeholder="Major" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="inp-school" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white">
                                ${SCHOOLS.map(s => `<option class="text-black" value="${s}">${s}</option>`).join('')}
                            </select>
                            <select id="inp-gender" class="bg-black/20 border border-white/10 rounded-xl p-3 text-white">
                                ${GENDERS.map(g => `<option class="text-black" value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                        <textarea id="inp-bio" placeholder="Bio..." class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white" rows="2"></textarea>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl space-y-4">
                        <div><div class="flex justify-between text-xs mb-1"><span>Messy</span><span>Clean</span></div><input id="inp-clean" type="range" min="1" max="5" value="3" class="w-full"></div>
                        <div><div class="flex justify-between text-xs mb-1"><span>Quiet</span><span>Loud</span></div><input id="inp-noise" type="range" min="1" max="5" value="3" class="w-full"></div>
                    </div>
                    <button onclick="saveProfile()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg">Join Pool</button>
                </div>
            `;
        }

        function renderDashboard() {
            if (state.official) {
                const p = state.official;
                appContainer.innerHTML = `
                    <div class="flex-1 flex flex-col items-center justify-center p-4">
                        <div class="w-full glass-panel rounded-3xl border border-emerald-500 p-8 text-center shadow-[0_0_30px_rgba(16,185,129,0.3)]">
                            <i data-lucide="crown" class="w-16 h-16 text-yellow-300 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Official Roommate</h2>
                            <h3 class="text-3xl font-bold text-emerald-300 mb-6">${p.name || 'Roommate'}</h3>
                            <button onclick="openChat({id: '${p.id}', name: '${p.name || 'Roommate'}', major: '${p.major || ''}'})" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold mb-4">Chat</button>
                            <button onclick="resetProfile()" class="text-sm text-emerald-200/50 hover:text-white">Leave Roommate</button>
                        </div>
                    </div>
                `;
                return;
            }

            const current = state.matches[0];
            const userName = state.profile?.name?.split(' ')[0] || 'User';
            const userSchool = state.profile?.school || 'School';
            
            const header = `
                <div class="flex justify-between items-center mb-4 pt-4">
                    <div><h1 class="text-xl font-bold text-white">Hi, ${userName}</h1><p class="text-xs text-indigo-300">${userSchool}</p></div>
                    <button onclick="resetProfile()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="log-out" class="w-5 h-5 text-indigo-300"></i></button>
                </div>
            `;

            if (!current) {
                appContainer.innerHTML = header + `
                    <div class="flex-1 flex flex-col items-center justify-center text-center p-8">
                        <div class="bg-indigo-500/20 p-4 rounded-full mb-4"><i data-lucide="search" class="w-8 h-8 text-indigo-300"></i></div>
                        <h3 class="text-xl font-bold mb-2">No matches yet</h3>
                        <p class="text-indigo-200">Waiting for other ${state.profile?.gender || ''} students at ${userSchool}...</p>
                    </div>`;
                return;
            }

            const rotation = state.dragOffset * 0.05;
            const transform = `translateX(${state.dragOffset}px) rotate(${rotation}deg)`;
            
            appContainer.innerHTML = header + `
                <div class="flex-1 relative w-full h-full perspective">
                    <div id="swipe-card" class="absolute inset-0 p-2 cursor-grab active:cursor-grabbing" style="transform: ${transform}; transition: transform 0.1s;">
                        <div class="w-full h-full glass-panel rounded-3xl overflow-hidden flex flex-col bg-indigo-900/80">
                            <div class="h-32 flex flex-col items-center justify-center bg-gradient-to-b from-indigo-500/30 to-transparent">
                                <span class="text-5xl font-bold text-white neon-text">${current.score}%</span>
                                <span class="text-xs uppercase tracking-widest text-indigo-200 mt-1">Match</span>
                            </div>
                            <div class="p-6 flex-1 flex flex-col relative">
                                ${state.dragOffset > 80 ? '<div class="absolute top-4 left-4 border-4 border-emerald-400 text-emerald-400 font-bold text-4xl px-2 py-1 rounded rotate-[-12deg] z-50">CHAT</div>' : ''}
                                ${state.dragOffset < -80 ? '<div class="absolute top-4 right-4 border-4 border-rose-500 text-rose-500 font-bold text-4xl px-2 py-1 rounded rotate-[12deg] z-50">SKIP</div>' : ''}
                                <div class="mb-4">
                                    <h3 class="text-3xl font-bold text-white mb-1">${current.name}</h3>
                                    <p class="text-indigo-200 text-sm">${current.major}</p>
                                </div>
                                <p class="text-white/90 text-lg leading-relaxed mb-6 flex-1">"${current.bio}"</p>
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <div class="bg-white/5 p-2 rounded text-center"><div class="text-[10px] text-indigo-300 font-bold">CLEAN</div><div>${current.clean}/5</div></div>
                                    <div class="bg-white/5 p-2 rounded text-center"><div class="text-[10px] text-indigo-300 font-bold">NOISE</div><div>${current.noise}/5</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="absolute bottom-6 w-full flex justify-center gap-8 pointer-events-none">
                        <button onclick="handleSwipe('left')" class="pointer-events-auto w-16 h-16 rounded-full border-2 border-rose-500 text-rose-500 flex items-center justify-center bg-black/40 backdrop-blur"><i data-lucide="x" class="w-8 h-8"></i></button>
                        <button onclick="handleSwipe('right')" class="pointer-events-auto w-16 h-16 rounded-full border-2 border-emerald-500 text-emerald-500 flex items-center justify-center bg-black/40 backdrop-blur"><i data-lucide="message-circle" class="w-8 h-8"></i></button>
                    </div>
                </div>
            `;
            
            attachSwipeListeners();
        }

        function renderChat() {
            appContainer.innerHTML = `
                <div class="h-full flex flex-col glass-panel rounded-2xl overflow-hidden mt-4">
                    <div class="p-4 flex justify-between items-center bg-white/5 border-b border-white/10">
                        <div class="flex items-center gap-3">
                            <button onclick="goBack()" class="hover:bg-white/10 p-1 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div><h3 class="font-bold">${state.chatPartner.name}</h3><p class="text-xs text-indigo-300">${state.chatPartner.major}</p></div>
                        </div>
                        <button onclick="requestMatch()" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-lg font-medium">Request</button>
                    </div>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
                        ${state.messages.map(m => {
                            if (m.type === 'proposal' && m.senderId !== state.user.uid) {
                                return `<div class="w-full bg-indigo-500/20 border border-indigo-500 p-4 rounded-xl text-center"><p class="mb-2 font-bold text-indigo-200">Wants to be Official!</p><button onclick="acceptMatch()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm">Accept</button></div>`;
                            }
                            const isMe = m.senderId === state.user.uid;
                            return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-[80%] p-3 rounded-2xl text-sm ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white/10 text-white rounded-bl-none'}">${m.text}</div></div>`;
                        }).join('')}
                    </div>
                    <form onsubmit="sendMessage(event)" class="p-3 bg-black/20 flex gap-2">
                        <input id="chat-input" type="text" placeholder="Message..." class="flex-1 bg-white/5 border border-white/10 rounded-full px-4 text-white focus:outline-none" autocomplete="off">
                        <button type="submit" class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            `;
        }

        function attachSwipeListeners() {
            const card = document.getElementById('swipe-card');
            if(!card) return;
            let startX = 0;
            const onMove = (x) => {
                if(!startX) return;
                state.dragOffset = x - startX;
                const rot = state.dragOffset * 0.05;
                card.style.transform = `translateX(${state.dragOffset}px) rotate(${rot}deg)`;
            };
            const onEnd = () => {
                if(state.dragOffset > 100) window.handleSwipe('right');
                else if(state.dragOffset < -100) window.handleSwipe('left');
                else { state.dragOffset = 0; renderDashboard(); }
                startX = 0;
            };
            card.addEventListener('mousedown', e => startX = e.clientX);
            window.addEventListener('mousemove', e => startX && onMove(e.clientX));
            window.addEventListener('mouseup', () => startX && onEnd());
            card.addEventListener('touchstart', e => startX = e.touches[0].clientX);
            card.addEventListener('touchmove', e => onMove(e.touches[0].clientX));
            card.addEventListener('touchend', () => onEnd());
        }

        function initBackground() {
            const c = document.getElementById('bg-effects');
            const svg = `<div class="absolute top-0 w-full h-32 opacity-30"><svg width="100%" height="100%" class="animate-sway"><path d="M0,0 Q50,50 100,0 T200,0 T300,0 T400,0 T500,0 T600,0 T700,0 T800,0 T900,0 T1000,0 T1200,0" fill="none" stroke="white" stroke-width="2"/><circle cx="10%" cy="25" r="4" fill="#FDE68A" class="animate-pulse"/><circle cx="50%" cy="25" r="4" fill="#FDE68A" class="animate-pulse"/><circle cx="90%" cy="25" r="4" fill="#FDE68A" class="animate-pulse"/></svg></div>`;
            c.innerHTML = svg;
            for(let i=0; i<6; i++) {
                const z = document.createElement('div');
                z.innerText = 'Z';
                z.className = 'absolute text-indigo-300/20 font-serif font-bold animate-float';
                z.style.left = Math.random()*100+'%'; z.style.fontSize=(Math.random()*2+1)+'rem'; z.style.animationDelay=(Math.random()*10)+'s'; z.style.bottom='-50px';
                c.appendChild(z);
            }
        }

        init();
    </script>
</body>
</html>
